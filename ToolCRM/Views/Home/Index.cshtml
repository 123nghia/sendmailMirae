@model ToolCRM.Models.InputRequest
@{
    ViewData["Title"] = "Dashboard";
}

<!-- Loading Overlay -->
<div id="showLoadding" class="loading-overlay" style="display:none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <h3 class="loading-title">Đang xử lý...</h3>
        <p class="loading-message">Vui lòng chờ kết quả</p>
        <div class="loading-progress">
            <div class="progress-bar"></div>
        </div>
    </div>
</div>



<!-- Main Features -->
<div class="row" id="contentdiv">
    <!-- File Upload Section -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload & Xử Lý Báo Cáo</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/" id="formSubmitReport" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dayReportTime" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Ngày làm báo cáo
                            </label>
                            <input type="date" class="form-control" name="DayReport" id="dayReportTime">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-excel me-1"></i>File nhân viên
                            </label>
                            <input class="form-control" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" name="FileTC" id="fileFileTC">
                            <small class="form-text text-muted">
                                <a href="/Tc.xlsx" download="dataTCTemplate.xlsx" class="text-decoration-none">
                                    <i class="fas fa-download me-1"></i>File mẫu
                                </a>
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-chart-line me-1"></i>File báo cáo hàng ngày (CDR)
                        </label>
                        <input class="form-control" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" name="FileReport" id="fileFileReport">
                        <small class="form-text text-muted">
                            <a href="/call_report_20250211.xlsx" download="dataCDR.xlsx" class="text-decoration-none">
                                <i class="fas fa-download me-1"></i>File mẫu
                            </a>
                        </small>
                    </div>
                    <button type="button" onclick="submitFormEnhanced()" class="btn btn-primary btn-admin">
                        <i class="fas fa-sync me-2"></i>Đồng bộ báo cáo
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Thao tác nhanh</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-admin" onclick="sendEmail()">
                        <i class="fas fa-envelope me-2"></i>Gửi Email Báo Cáo
                    </button>
                    <button type="button" class="btn btn-outline-success btn-admin" onclick="sendLatestPaymentEmail()">
                        <i class="fas fa-paper-plane me-2"></i>Gửi Lại Email Payment
                    </button>
                    <button type="button" class="btn btn-info btn-admin" onclick="downloadPayment()">
                        <i class="fas fa-download me-2"></i>Tải File Payment
                    </button>
                    <button type="button" class="btn btn-warning btn-admin" onclick="uploadToSFTP()">
                        <i class="fas fa-upload me-2"></i>Upload Lên SFTP
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showLoading() {
    var loadingDiv = document.getElementById('showLoadding');
    if (loadingDiv) {
        loadingDiv.style.display = 'flex';
        setTimeout(function() {
            loadingDiv.style.opacity = "1";
        }, 10);
    }
}

function showLoadingOverlay(title, message) {
    var loadingDiv = document.getElementById('showLoadding');
    if (loadingDiv) {
        var titleElement = loadingDiv.querySelector('.loading-title');
        var messageElement = loadingDiv.querySelector('.loading-message');
        
        if (titleElement) titleElement.textContent = title;
        if (messageElement) messageElement.textContent = message;
        
        loadingDiv.style.display = "flex";
        
        // Add fade-in animation
        setTimeout(function() {
            loadingDiv.style.opacity = "1";
        }, 10);
    }
}

function showAlert(message, type = "info", details = null) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-toast');
    existingAlerts.forEach(alert => alert.remove());

    // Create alert element
    var alertDiv = document.createElement('div');
    alertDiv.className = `alert-toast alert-${type}`;
    
    // Set icon based on type
    let icon = 'fas fa-info-circle';
    if (type === 'success') icon = 'fas fa-check-circle';
    else if (type === 'danger' || type === 'error') icon = 'fas fa-exclamation-circle';
    else if (type === 'warning') icon = 'fas fa-exclamation-triangle';
    else if (type === 'system_error') icon = 'fas fa-bug';
    
    // Create details section if provided
    let detailsHtml = '';
    if (details) {
        detailsHtml = `
            <div class="alert-details">
                <small>${details}</small>
            </div>
        `;
    }
    
    alertDiv.innerHTML = `
        <div class="alert-content">
            <i class="${icon}"></i>
            <div class="alert-text">
                <div class="alert-message">${message}</div>
                ${detailsHtml}
            </div>
        </div>
        <button class="alert-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;

    // Add to page
    document.body.appendChild(alertDiv);

    // Auto remove after 8 seconds for errors, 5 seconds for others
    const timeout = (type === 'danger' || type === 'error' || type === 'system_error') ? 8000 : 5000;
    setTimeout(function() {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, timeout);
}

// Enhanced submit form function
function submitFormEnhanced() {
    var dayReport = document.getElementById("dayReportTime").value;
    if (dayReport.length < 1) { 
        showAlert("Vui lòng chọn ngày báo cáo", "warning");
        return;
    }
    
    var fileTCInput = document.getElementById("fileFileTC");
    if (fileTCInput.files.length < 1) {
        showAlert("Vui lòng chọn file TC (File nhân viên)", "warning");
        return;
    }
 
    var fileReportCDRInput = document.getElementById("fileFileReport");
    if (fileReportCDRInput.files.length < 1) {
        showAlert("Vui lòng chọn file báo cáo (File CDR)", "warning");
        return;
    }
    
    // Show loading overlay
    showLoadingOverlay("Đang xử lý file...", "Vui lòng chờ kết quả");
    
    // Disable submit button
    var submitBtn = document.querySelector('button[onclick="submitFormEnhanced()"]');
    if (submitBtn) {
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;
    }
    
    // Submit form after a short delay
    setTimeout(function() {
        document.getElementById('formSubmitReport').submit();
    }, 1000);
}
</script>