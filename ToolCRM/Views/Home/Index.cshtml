@model ToolCRM.Models.InputRequest
@{
    ViewData["Title"] = "Dashboard";
}

<!-- Loading Overlay -->
<div id="showLoadding" class="loading-overlay" style="display:none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <h3 class="loading-title">Đang xử lý...</h3>
        <p class="loading-message">Vui lòng chờ kết quả</p>
        <div class="loading-progress">
            <div class="progress-bar"></div>
        </div>
    </div>
</div>

<!-- Dashboard Stats -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-file-upload fa-2x mb-2"></i>
                <h5>File Upload</h5>
                <p class="mb-0">Xử lý báo cáo</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-envelope fa-2x mb-2"></i>
                <h5>Email System</h5>
                <p class="mb-0">Gửi báo cáo tự động</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-server fa-2x mb-2"></i>
                <h5>SFTP Server</h5>
                <p class="mb-0">Quản lý file từ xa</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-tasks fa-2x mb-2"></i>
                <h5>Job Scheduler</h5>
                <p class="mb-0">Tự động hóa tác vụ</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Features -->
<div class="row" id="contentdiv">
    <!-- File Upload Section -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload & Xử Lý Báo Cáo</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/" id="formSubmitReport" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dayReportTime" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Ngày làm báo cáo
                            </label>
                            <input type="date" class="form-control" name="DayReport" id="dayReportTime">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-file-excel me-1"></i>File nhân viên
                            </label>
                            <input class="form-control" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" name="FileTC" id="fileFileTC">
                            <small class="form-text text-muted">
                                <a href="/Tc.xlsx" download="dataTCTemplate.xlsx" class="text-decoration-none">
                                    <i class="fas fa-download me-1"></i>File mẫu
                                </a>
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-chart-line me-1"></i>File báo cáo hàng ngày (CDR)
                        </label>
                        <input class="form-control" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" name="FileReport" id="fileFileReport">
                        <small class="form-text text-muted">
                            <a href="/call_report_20250211.xlsx" download="dataCDR.xlsx" class="text-decoration-none">
                                <i class="fas fa-download me-1"></i>File mẫu
                            </a>
                        </small>
                    </div>
                    <button type="button" onclick="submitFormEnhanced()" class="btn btn-primary btn-admin">
                        <i class="fas fa-sync me-2"></i>Đồng bộ báo cáo
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Thao tác nhanh</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-admin" onclick="sendEmail()">
                        <i class="fas fa-envelope me-2"></i>Gửi Email Báo Cáo
                    </button>
                    <button type="button" class="btn btn-outline-success btn-admin" onclick="sendLatestPaymentEmail()">
                        <i class="fas fa-paper-plane me-2"></i>Gửi Lại Email Payment
                    </button>
                    <button type="button" class="btn btn-info btn-admin" onclick="downloadPayment()">
                        <i class="fas fa-download me-2"></i>Tải File Payment
                    </button>
                    <button type="button" class="btn btn-warning btn-admin" onclick="uploadToSFTP()">
                        <i class="fas fa-upload me-2"></i>Upload Lên SFTP
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Management -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="feature-icon bg-primary text-white">
                    <i class="fas fa-server"></i>
                </div>
                <h5>SFTP Browser</h5>
                <p class="text-muted">Duyệt và tải xuống file từ SFTP server</p>
                <a href="/Sftp" class="btn btn-outline-primary btn-admin">
                    <i class="fas fa-external-link-alt me-2"></i>Mở SFTP Browser
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="feature-icon bg-warning text-white">
                    <i class="fas fa-tasks"></i>
                </div>
                <h5>Job Management</h5>
                <p class="text-muted">Quản lý và theo dõi các tác vụ tự động</p>
                <a href="/Job" class="btn btn-outline-warning btn-admin">
                    <i class="fas fa-external-link-alt me-2"></i>Mở Job Manager
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* Alert Toast Styles */
.alert-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    min-width: 350px;
    max-width: 500px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    border-left: 4px solid #007bff;
    animation: slideInRight 0.3s ease-out;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.alert-toast.alert-success {
    border-left-color: #28a745;
}

.alert-toast.alert-danger,
.alert-toast.alert-error {
    border-left-color: #dc3545;
}

.alert-toast.alert-warning {
    border-left-color: #ffc107;
}

.alert-toast.alert-system_error {
    border-left-color: #6f42c1;
}

.alert-content {
    display: flex;
    align-items: flex-start;
    padding: 16px;
    gap: 12px;
}

.alert-content i {
    font-size: 20px;
    margin-top: 2px;
    flex-shrink: 0;
}

.alert-toast.alert-success i {
    color: #28a745;
}

.alert-toast.alert-danger i,
.alert-toast.alert-error i {
    color: #dc3545;
}

.alert-toast.alert-warning i {
    color: #ffc107;
}

.alert-toast.alert-system_error i {
    color: #6f42c1;
}

.alert-text {
    flex: 1;
}

.alert-message {
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
    line-height: 1.4;
}

.alert-details {
    color: #666;
    font-size: 13px;
    line-height: 1.3;
    margin-top: 4px;
}

.alert-close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.alert-close:hover {
    background: #f5f5f5;
    color: #666;
}

@@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Loading Overlay Styles */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.loading-content {
    background: white;
    padding: 40px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 90%;
}

.loading-spinner {
    margin-bottom: 20px;
}

.loading-title {
    color: #333;
    margin-bottom: 10px;
    font-weight: 600;
}

.loading-message {
    color: #666;
    margin-bottom: 20px;
}

.loading-progress {
    width: 100%;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #0056b3);
    border-radius: 2px;
    animation: progressAnimation 2s ease-in-out infinite;
}

@@keyframes progressAnimation {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 100%; }
}
</style>

<script>
function showLoading() {
    var loadingDiv = document.getElementById('showLoadding');
    if (loadingDiv) {
        loadingDiv.style.display = 'flex';
        setTimeout(function() {
            loadingDiv.style.opacity = "1";
        }, 10);
    }
}

function showLoadingOverlay(title, message) {
    var loadingDiv = document.getElementById('showLoadding');
    if (loadingDiv) {
        var titleElement = loadingDiv.querySelector('.loading-title');
        var messageElement = loadingDiv.querySelector('.loading-message');
        
        if (titleElement) titleElement.textContent = title;
        if (messageElement) messageElement.textContent = message;
        
        loadingDiv.style.display = "flex";
        
        // Add fade-in animation
        setTimeout(function() {
            loadingDiv.style.opacity = "1";
        }, 10);
    }
}

function showAlert(message, type = "info", details = null) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-toast');
    existingAlerts.forEach(alert => alert.remove());

    // Create alert element
    var alertDiv = document.createElement('div');
    alertDiv.className = `alert-toast alert-${type}`;
    
    // Set icon based on type
    let icon = 'fas fa-info-circle';
    if (type === 'success') icon = 'fas fa-check-circle';
    else if (type === 'danger' || type === 'error') icon = 'fas fa-exclamation-circle';
    else if (type === 'warning') icon = 'fas fa-exclamation-triangle';
    else if (type === 'system_error') icon = 'fas fa-bug';
    
    // Create details section if provided
    let detailsHtml = '';
    if (details) {
        detailsHtml = `
            <div class="alert-details">
                <small>${details}</small>
            </div>
        `;
    }
    
    alertDiv.innerHTML = `
        <div class="alert-content">
            <i class="${icon}"></i>
            <div class="alert-text">
                <div class="alert-message">${message}</div>
                ${detailsHtml}
            </div>
        </div>
        <button class="alert-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;

    // Add to page
    document.body.appendChild(alertDiv);

    // Auto remove after 8 seconds for errors, 5 seconds for others
    const timeout = (type === 'danger' || type === 'error' || type === 'system_error') ? 8000 : 5000;
    setTimeout(function() {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, timeout);
}

// Enhanced submit form function
function submitFormEnhanced() {
    var dayReport = document.getElementById("dayReportTime").value;
    if (dayReport.length < 1) { 
        showAlert("Vui lòng chọn ngày báo cáo", "warning");
        return;
    }
    
    var fileTCInput = document.getElementById("fileFileTC");
    if (fileTCInput.files.length < 1) {
        showAlert("Vui lòng chọn file TC (File nhân viên)", "warning");
        return;
    }
 
    var fileReportCDRInput = document.getElementById("fileFileReport");
    if (fileReportCDRInput.files.length < 1) {
        showAlert("Vui lòng chọn file báo cáo (File CDR)", "warning");
        return;
    }
    
    // Show loading overlay
    showLoadingOverlay("Đang xử lý file...", "Vui lòng chờ kết quả");
    
    // Disable submit button
    var submitBtn = document.querySelector('button[onclick="submitFormEnhanced()"]');
    if (submitBtn) {
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;
    }
    
    // Submit form after a short delay
    setTimeout(function() {
        document.getElementById('formSubmitReport').submit();
    }, 1000);
}
</script>