@{
    ViewData["Title"] = "SFTP File Manager";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-server me-2"></i>SFTP File Manager
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Connection Info -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="fas fa-server me-2"></i>Connection Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Host:</strong> @ViewBag.SftpHost</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Port:</strong> @ViewBag.SftpPort</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Status -->
                    <div class="alert alert-info d-flex align-items-center mb-3" id="connectionStatus">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Connection Status:</strong>
                            <span id="statusText">Checking...</span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button id="btnRefresh" class="btn btn-primary">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                            <button id="btnTestConnection" class="btn btn-success ms-2">
                                <i class="fas fa-network-wired me-1"></i>Test Connection
                            </button>
                            <button id="btnSendPayment" class="btn btn-warning ms-2">
                                <i class="fas fa-paper-plane me-1"></i>Send Latest Payment
                            </button>
                        </div>
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search files...">
                            <button class="btn btn-outline-secondary" type="button" id="btnSearch">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="filesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>File Name</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Last Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="filesTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading files...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    checkConnection();
    loadFiles();

    $('#btnRefresh').click(function() {
        loadFiles();
    });

    $('#btnTestConnection').click(function() {
        checkConnection();
    });

    $('#btnSendPayment').click(function() {
        sendLatestPayment();
    });

    $('#btnSearch').click(function() {
        filterTable();
    });

    $('#searchInput').on('keyup', function(e) {
        if (e.key === 'Enter') {
            filterTable();
        }
    });

    function checkConnection() {
        $('#statusText').text('Checking connection...');
        $('#connectionStatus').removeClass('alert-success alert-danger alert-warning')
                              .addClass('alert-info');

        $.ajax({
            url: '/Sftp/GetFiles',
            type: 'GET',
            dataType: 'json',
            timeout: 10000,
            success: function(response) {
                if (response.success) {
                    updateConnectionStatus('Connected', 'alert-success', 
                        'Connection successful: ' + response.files.length + ' files found');
                } else {
                    updateConnectionStatus('Error', 'alert-danger', 
                        'Connection error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                var errorMsg = 'Connection failed: ';
                if (status === 'timeout') {
                    errorMsg += 'Connection timeout. Please check your network and SFTP server.';
                } else if (xhr.status === 0) {
                    errorMsg += 'Cannot connect to server. Please check if the service is running.';
                } else {
                    errorMsg += error + ' (Status: ' + status + ')';
                }
                updateConnectionStatus('Disconnected', 'alert-danger', errorMsg);
            }
        });
    }

    function updateConnectionStatus(status, alertClass, message) {
        $('#statusText').text(status + ' - ' + message);
        $('#connectionStatus').removeClass('alert-info alert-success alert-danger alert-warning')
                              .addClass(alertClass);
    }

    function sendLatestPayment() {
        if (!confirm('Bạn có chắc chắn muốn gửi file payment mới nhất qua email?')) {
            return;
        }

        var btn = $('#btnSendPayment');
        var originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Sending...');

        $.ajax({
            url: '/Sftp/SendLatestPayment',
            type: 'POST',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    alert('File payment đã được gửi thành công!');
                } else {
                    alert('Lỗi gửi file: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('Lỗi gửi file: ' + error);
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    }

    function loadFiles() {
        $.ajax({
            url: '/Sftp/GetFiles',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    displayFiles(response.files);
                } else {
                    showError('Failed to load files: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                showError('Error loading files: ' + error);
            }
        });
    }

    function displayFiles(files) {
        var tbody = $('#filesTableBody');
        tbody.empty();

        if (files.length === 0) {
            tbody.append('<tr><td colspan="5" class="text-center text-muted">No files found</td></tr>');
            return;
        }

        files.forEach(function(file) {
            var sizeText = formatFileSize(file.size);
            var dateText = new Date(file.lastModified).toLocaleString('vi-VN');
            var badgeClass = file.type === 'WorkingTime' ? 'bg-info' : 'bg-success';

            var row = '<tr>' +
                '<td><i class="fas fa-file-excel text-success me-2"></i>' + escapeHtml(file.name) + '</td>' +
                '<td><span class="badge ' + badgeClass + '">' + file.type + '</span></td>' +
                '<td>' + sizeText + '</td>' +
                '<td>' + dateText + '</td>' +
                '<td>' +
                    '<button class="btn btn-sm btn-primary" onclick="downloadFile(\'' + encodeURIComponent(file.path) + '\')">' +
                        '<i class="fas fa-download me-1"></i>Download' +
                    '</button>' +
                '</td>' +
            '</tr>';

            tbody.append(row);
        });
    }

    function filterTable() {
        var searchText = $('#searchInput').val().toLowerCase();
        $('#filesTableBody tr').each(function() {
            var rowText = $(this).text().toLowerCase();
            $(this).toggle(rowText.indexOf(searchText) > -1);
        });
    }

    window.downloadFile = function(filePath) {
        window.location.href = '/Sftp/DownloadFile?filePath=' + filePath;
    };

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        var k = 1024;
        var sizes = ['B', 'KB', 'MB', 'GB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function showError(message) {
        $('#filesTableBody').html(
            '<tr><td colspan="5" class="text-center text-danger">' + 
            '<i class="fas fa-exclamation-triangle me-2"></i>' + 
            escapeHtml(message) + 
            '</td></tr>'
        );
    }
});
</script>
}
